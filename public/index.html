<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bookshop</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f8f9fa; margin: 0; }
    .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 32px; }
    h1 { text-align: center; color: #2c3e50; }
    h2 { color: #34495e; margin-top: 32px; }
    input, button, select, textarea { padding: 8px; margin: 4px 0; border-radius: 4px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
    button { background: #ee1409; color: #fff; border: none; cursor: pointer; width: auto; }
    button:hover { background: #dedb00; }
    .book-list { list-style: none; padding: 0; }
    .book-list li { margin: 12px 0; padding: 12px; background: #f0f4f8; border-radius: 6px; }
    .review { background: #eaf6ff; margin: 6px 0; padding: 6px 12px; border-radius: 4px; }
    .error { color: #c0392b; }
    .success { color: #27ae60; }
    .flex { display: flex; gap: 8px; align-items: center; }
    .review-actions { margin-top: 8px; }
    .section { margin-bottom: 32px; padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px; }
    .auth-section { background: #f8fff8; }
    .token-display { background: #fff3cd; padding: 8px; border-radius: 4px; margin: 8px 0; font-family: monospace; font-size: 12px; word-break: break-all; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“š Bookshop Assignment Demo</h1>

    <!-- Task 1 -->
    <div class="section">
      <h2>Task 1: Get All Books</h2>
      <button onclick="loadBooks()">Show All Books</button>
      <ul id="book-list" class="book-list"></ul>
    </div>

    <!-- Task 2 -->
    <div class="section">
      <h2>Task 2: Get Book by ISBN</h2>
      <input id="search-isbn" placeholder="Enter ISBN (e.g., 12345)">
      <button onclick="searchByISBN()">Search ISBN</button>
      <ul id="isbn-result" class="book-list"></ul>
    </div>

    <!-- Task 3 -->
    <div class="section">
      <h2>Task 3: Get Books by Author</h2>
      <input id="search-author" placeholder="Enter Author (e.g., JK Rowling)">
      <button onclick="searchByAuthor()">Search Author</button>
      <ul id="author-result" class="book-list"></ul>
    </div>

    <!-- Task 4 -->
    <div class="section">
      <h2>Task 4: Get Books by Title</h2>
      <input id="search-title" placeholder="Enter Title (e.g., Harry Potter)">
      <button onclick="searchByTitle()">Search Title</button>
      <ul id="title-result" class="book-list"></ul>
    </div>

    <!-- Task 5 -->
    <div class="section">
      <h2>Task 5: Get Book Review</h2>
      <input id="review-isbn" placeholder="Enter ISBN (e.g., 12345)">
      <button onclick="showReviewsForTask5()">Show Reviews</button>
      <div id="task5-reviews"></div>
    </div>

    <!-- Task 6 -->
    <div class="section auth-section">
      <h2>Task 6: Register New User</h2>
      <input id="register-username" placeholder="Username">
      <input id="register-password" type="password" placeholder="Password">
      <button onclick="register()">Register</button>
      <div id="register-msg"></div>
    </div>

    <!-- Task 7 -->
    <div class="section auth-section">
      <h2>Task 7: Login as Registered User</h2>
      <input id="login-username" placeholder="Username">
      <input id="login-password" type="password" placeholder="Password">
      <button onclick="login()">Login</button>
      <div id="login-msg"></div>
      <div id="logged-in-user" style="margin-top:8px;"></div>
      <div id="token-display" class="token-display" style="display:none;"></div>
    </div>

    <!-- Task 8 -->
    <div class="section auth-section">
      <h2>Task 8: Add/Modify Review (Registered Users Only)</h2>
      <input id="review-book-isbn-8" placeholder="Enter ISBN (e.g., 12345)">
      <textarea id="review-text-8" rows="3" placeholder="Your review"></textarea>
      <button onclick="submitReviewForTask8()">Add/Modify Review</button>
      <div id="review-action-msg-8"></div>
    </div>

    <!-- Task 9 -->
    <div class="section auth-section">
      <h2>Task 9: Delete My Review (Registered Users Only)</h2>
      <input id="review-book-isbn-9" placeholder="Enter ISBN (e.g., 12345)">
      <button onclick="deleteReviewForTask9()">Delete My Review</button>
      <div id="review-action-msg-9"></div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let authToken = null;

    // Task 1
    function loadBooks() {
      fetch('/books')
        .then(res => res.json())
        .then(data => {
          const ul = document.getElementById('book-list');
          ul.innerHTML = data.map(book =>
            `<li><b>${book.title}</b> by ${book.author} (ISBN: ${book.isbn})</li>`
          ).join('');
        })
        .catch(err => {
          document.getElementById('book-list').innerHTML = `<li class="error">Error: ${err}</li>`;
        });
    }

    // Task 2
    function searchByISBN() {
      const isbn = document.getElementById('search-isbn').value.trim();
      if (!isbn) return alert('Please enter ISBN');
      fetch('/books/isbn/' + isbn)
        .then(res => res.ok ? res.json() : Promise.reject("Book not found"))
        .then(book => {
          const ul = document.getElementById('isbn-result');
          ul.innerHTML = `<li><b>${book.title}</b> by ${book.author} (ISBN: ${book.isbn})</li>`;
        })
        .catch((err) => {
          document.getElementById('isbn-result').innerHTML = `<li class="error">${err}</li>`;
        });
    }

    // Task 3
    function searchByAuthor() {
      const author = document.getElementById('search-author').value.trim();
      if (!author) return alert('Please enter author name');
      fetch('/books/author/' + encodeURIComponent(author))
        .then(res => res.json())
        .then(books => {
          const ul = document.getElementById('author-result');
          ul.innerHTML = books.length
            ? books.map(book =>
                `<li><b>${book.title}</b> by ${book.author} (ISBN: ${book.isbn})</li>`
              ).join('')
            : "<li>No books found for this author.</li>";
        })
        .catch(err => {
          document.getElementById('author-result').innerHTML = `<li class="error">Error: ${err}</li>`;
        });
    }

    // Task 4
    function searchByTitle() {
      const title = document.getElementById('search-title').value.trim();
      if (!title) return alert('Please enter book title');
      fetch('/books/title/' + encodeURIComponent(title))
        .then(res => res.json())
        .then(books => {
          const ul = document.getElementById('title-result');
          ul.innerHTML = books.length
            ? books.map(book =>
                `<li><b>${book.title}</b> by ${book.author} (ISBN: ${book.isbn})</li>`
              ).join('')
            : "<li>No books found with this title.</li>";
        })
        .catch(err => {
          document.getElementById('title-result').innerHTML = `<li class="error">Error: ${err}</li>`;
        });
    }

    // Task 5
    function showReviewsForTask5() {
      const isbn = document.getElementById('review-isbn').value.trim();
      if (!isbn) return alert('Please enter ISBN');
      fetch(`/books/review/${isbn}`)
        .then(res => res.ok ? res.json() : Promise.reject("Book not found"))
        .then(reviews => {
          const div = document.getElementById('task5-reviews');
          div.innerHTML = "<h3>Reviews:</h3>" + (
            Object.keys(reviews).length
              ? Object.entries(reviews).map(([user, review]) =>
                  `<div class="review"><b>${user}:</b> ${review}</div>`
                ).join("")
              : "<div>No reviews yet.</div>"
          );
        })
        .catch((err) => {
          document.getElementById('task5-reviews').innerHTML = `<div class="error">${err}</div>`;
        });
    }

    // Task 6 - FIXED: Handle JSON response
    function register() {
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value;
      
      if (!username || !password) return alert('Please enter username and password');
      
      fetch('/register', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username, password})
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('register-msg').innerHTML = `<span class="success">${data.message}</span>`;
      })
      .catch(err => {
        document.getElementById('register-msg').innerHTML = `<span class="error">Registration failed: ${err.message || err}</span>`;
      });
    }

    // Task 7 - FIXED: Handle JSON response and store token
    function login() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      
      if (!username || !password) return alert('Please enter username and password');
      
      fetch('/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username, password})
      })
      .then(res => res.json())
      .then(data => {
        if (data.token) {
          currentUser = username;
          authToken = data.token;
          document.getElementById('logged-in-user').innerHTML = `<span class="success">âœ… Logged in as: ${username}</span>`;
          document.getElementById('login-msg').innerHTML = `<span class="success">${data.message}</span>`;
          document.getElementById('token-display').style.display = 'block';
          document.getElementById('token-display').textContent = `Token: ${data.token.substring(0, 50)}...`;
        } else {
          throw new Error('No token received');
        }
      })
      .catch(err => {
        document.getElementById('login-msg').innerHTML = `<span class="error">Login failed: ${err.message || err}</span>`;
      });
    }

    // Task 8 - FIXED: Use JWT token instead of username in body
    function submitReviewForTask8() {
      const isbn = document.getElementById('review-book-isbn-8').value.trim();
      const review = document.getElementById('review-text-8').value.trim();
      
      if (!isbn || !review) return alert('Please enter ISBN and review');
      if (!authToken) return alert('Please login first');
      
      fetch(`/review/${isbn}`, {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify({review})
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('review-action-msg-8').innerHTML = `<span class="success">${data.message}</span>`;
      })
      .catch(err => {
        document.getElementById('review-action-msg-8').innerHTML = `<span class="error">Failed: ${err.message || err}</span>`;
      });
    }

    // Task 9 - FIXED: Use JWT token instead of username in query
    function deleteReviewForTask9() {
      const isbn = document.getElementById('review-book-isbn-9').value.trim();
      
      if (!isbn) return alert('Please enter ISBN');
      if (!authToken) return alert('Please login first');
      
      fetch(`/review/${isbn}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('review-action-msg-9').innerHTML = `<span class="success">${data.message}</span>`;
      })
      .catch(err => {
        document.getElementById('review-action-msg-9').innerHTML = `<span class="error">Failed: ${err.message || err}</span>`;
      });
    }
  </script>
</body>
</html>